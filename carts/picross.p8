pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
	campos={x=0,y=0}
	nowpos={x=1,y=1}
	nowpzl=2
	pzl={
		{sx=0,sy=32,w=10,h=10},
		{sx=10,sy=32,w=15,h=15},
		{sx=0,sy=42,w=5,h=5}
	}
	startgame(1)
end

function _update()
	buttons()
end

function _draw()
	cls()
	camera(campos.x,campos.y)
	drawgrid(pzl[nowpzl].w,pzl[nowpzl].h,
		dx,
		dy,
		nowpos.x,nowpos.y)
	drawboard(solve,dx,dy,pzl[nowpzl].w,pzl[nowpzl].h)
	disp_hintr(hn,dx,dy,7)
end

function buttons()
	if(btnp(‚¨ÜÔ∏è)and nowpos.y>1)nowpos.y-=1
	if(btnp(‚¨áÔ∏è)and nowpos.y<pzl[nowpzl].h)nowpos.y+=1
	if(btnp(‚¨ÖÔ∏è)and nowpos.x>1)nowpos.x-=1
	if(btnp(‚û°Ô∏è)and nowpos.x<pzl[nowpzl].w)nowpos.x+=1
	if btnp(üÖæÔ∏è) then
		if solve[nowpos.y][nowpos.x]==0 then
			solve[nowpos.y][nowpos.x]=1
		else
			solve[nowpos.y][nowpos.x]=0
		end
	end
	if btnp(‚ùé) then
		if solve[nowpos.y][nowpos.x]==0 then
			solve[nowpos.y][nowpos.x]=2
		else
			solve[nowpos.y][nowpos.x]=0
		end
	end
end

function startgame()
	hn=gethintnum(pzl[nowpzl])
	dx=127-pzl[nowpzl].w*(gs.x+1)
	dy=127-pzl[nowpzl].h*(gs.y+1)
	solve=createboard(pzl[nowpzl].w,pzl[nowpzl].h)
end

function createboard(w,h)
	local bd={}
	for i=1,h do
		local row={}
		for j=1,w do
			add(row,0)
		end
		add(bd,row)
	end
	return bd
end

-->8
--grid size
gs={x=5,y=5}
--grid color
--{border,line,every5line,nowblk
--,now line/row,filled}
gcl={7,6,9,12,12,7}
function drawgrid(gx,gy,x,y,nx,ny)
	local ex=gx*(gs.x+1)
	local ey=gy*(gs.y+1)
	for i=1,gx do
		local cl=gcl[2]
		if(i%5==0)cl=gcl[3]
		line(x+i*(gs.x+1),y,x+i*(gs.x+1),y+ey,cl)
	end
	for i=1,gy do
		local cl=gcl[2]
		if(i%5==0)cl=gcl[3]
		line(x,y+i*(gs.y+1),x+ex,y+i*(gs.y+1),cl)
	end
	--outer border
	rect(x,y,x+ex,y+ey,gcl[1])
	--now block
	rect(x+(nx-1)*(gs.x+1),y+(ny-1)*(gs.y+1),
		x+nx*(gs.x+1),y+ny*(gs.y+1),
		gcl[4])
	--now line/row
	rectfill(x+(nx-1)*(gs.x+1),y-1,
		x+nx*(gs.x+1),y-100,gcl[5])
	rectfill(x-1,y+(ny-1)*(gs.y+1),
		x-100,y+ny*(gs.y+1),gcl[5])
	--hint numbers
end

--0:now solved
--1:drawn
--2:x mark
function drawboard(bd,x,y,w,h)
	for r=1,h do
		for c=1,w do
			if bd[r][c]==1 then
				--spr(32,x+1+(c-1)*(gs.x+1),
				--y+1+(r-1)*(gs.y+1))
				local sx=x+1+(c-1)*(gs.x+1)
				local sy=y+1+(r-1)*(gs.y+1)
				rectfill(sx,sy,sx+gs.x-1,sy+gs.y-1,gcl[6])
			elseif bd[r][c]==2 then
				if gs.x==4 then
					spr(53,x+1+(c-1)*(gs.x+1),
					y+1+(r-1)*(gs.y+1))
				else
					spr(21,x+1+(c-1)*(gs.x+1),
					y+1+(r-1)*(gs.y+1))
				end
			end
		end
	end
end
-->8
--parse puzzle number
function gethintnum(pzl)
	local ht={u={},l={}}
	--left(rows)
	for i=1,pzl.h do
		local rown={}
		local accn=0
		for j=1,pzl.w do
			if sget(pzl.sx+j-1,pzl.sy+i-1)>0 then
				accn+=1
				if j==pzl.w then
					add(rown,accn)
				end
			else
				if accn>0 then
					add(rown,accn)
					accn=0
				end
			end
		end
		if(#rown==0)add(rown,0)
		add(ht.l,rown)	
	end
	--up(columns)
	for i=1,pzl.w do
		local coln={}
		local accn=0
		for j=1,pzl.h do
			if sget(pzl.sx+i-1,pzl.sy+j-1)>0 then
				accn+=1
				if j==pzl.h then
					add(coln,accn)
				end
			else
				if accn>0 then
					add(coln,accn)
					accn=0
				end
			end
		end
		if(#coln==0)add(coln,0)
		add(ht.u,coln)	
	end
	return ht
end

function disp_hintr(hn,x,y,cl)
	for r=1,#hn.l do
		disp_hint_rowr(hn.l[r],x-2,y+1+(gs.y+1)*(r-1),7)
	end
	for c=1,#hn.u do
		disp_hint_colr(hn.u[c],x+1+(gs.x+1)*(c-1),y-2,7)
	end
end

--right-left
function disp_hint_rowr(hr,x,y,n,cl)
	local sx=x-4
	for i=1,#hr do
		disphn(hr[#hr-i+1],sx-(i-1)*(gs.x+1),y,cl)
	end
end

--bottom-up
function disp_hint_colr(hc,x,y,n,cl)
	local sy=y-4
	for i=1,#hc do
		disphn(hc[#hc-i+1],x,sy-(i-1)*(gs.y+1),cl)
	end
end

function disphn(num,x,y,cl)
	if(cl!=nil)pal(7,cl)
	if gs.x==4 then
		spr(num+32,x,y)
	else
		spr(num,x,y)
	end
	pal()
end
__gfx__
07770000077000007777000077770000007700007777700007770000777770000777000007770000707770007007000070777000707770007070700070777000
70077000007000000000700000007000070700007000000070000000700070007000700070007000707070007007000070007000700070007070700070700000
70707000007000000777000007770000700700007777000077770000000700000777000007777000707070007007000070777000707770007077700070777000
77007000007000007000000000007000777770000000700070007000007000007000700000007000707070007007000070700000700070007000700070007000
07770000077700007777700077770000000700007777000007770000007000000777000007770000707770007007000070777000707770007000700070777000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70777000707770007077700070777000770770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70700000707070007070700070707000070770000606000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70777000700070007077700070777000770770000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70707000700070007070700070007000700770000606000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70777000700070007077700070777000770770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77770000777000007777000077770000707700007777000070000000777700000777000077770000707700007007000070770000707700007007000070770000
70770000077000000777000007770000707700007770000077770000007700000707000070070000707000007007000070070000700700007077000070700000
77070000077000007770000000770000777700000777000070070000007700007777000077770000707000007007000070700000700700007077000070070000
77770000777700007777000077770000007700007777000077770000007700007777000000070000707700007007000070770000707700007007000070770000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70700000707700007077000070770000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70700000700700007077000070770000077000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70770000700700007077000070070000707000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70770000700700007077000070070000777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007700007770000007000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077770007007000007000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00770077007777077707770070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777707007070707070070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777770077707770070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777770000000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777707777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077770007770777070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007700007070700077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070000007770777070007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77077000007007000000070070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007000007770007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77077000007007007070700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070000000007007770077700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
